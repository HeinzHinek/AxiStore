{% extends "base.html" %}
{% block content %}

<script>
$(document).ready(function() {

    $(".input-qty").focus(function(){
        $(this).on("mouseup.a keyup.a", function(e){
            $(this).off("mouseup.a keyup.a").select();
        });
    });

    $('form').bind("keyup keypress", function(e) {
        var code = e.keyCode || e.which;
        if (code  == 13) {
            e.preventDefault();
            return false;
        }
    });

    $(document).on('keyup', '.nums_only', function (e) {
        $(this).removeClass('td-border-highlighted');
        if (e.keyCode != '9') {
            this.value = this.value.replace(/[^0-9\.]/g,'');
        }
    });

    $('#btn_check').click( function() {
        inputs = $('.input-qty');
        var empty = true;
        for (var i=0; i<inputs.length; i++) {
            if ( $(inputs[i]).val() > 0 ) {
                empty = false;
                break;
            }
        }
        if (empty == true) {
            return;
        }
        for (var i=0; i<inputs.length; i++) {
            if ( $(inputs[i]).val() == 0 ) {
                $(inputs[i]).parent().parent().hide();
            } else {
                $span = $(inputs[i]).parent().find('span');
                $span.text($(inputs[i]).val());
                $(inputs[i]).hide();
                $span.show();
            }
        }
        $('.div-error').html('');
        $('#btn_check').hide();
        $('#btn_correct').show();
        $('#btn_submit').show();
    });

    $('#btn_correct').click( function() {
        $('.span-qty-order').hide();
        $('.input-qty').show();
        $('.tr-product').show();
        $('.div-error').html('');
        $('#btn_check').show();
        $('#btn_correct').hide();
        $('#btn_submit').hide();
    });

});
</script>

<h1>{{ _('Place a new order to maker') }}</h1>
{% include 'flash.html' %}

{% if formMaker and not products %}
<form action="" method="post" name="selectMaker">
    {{formMaker.hidden_tag()}}
    <table class="table no-border">
        <tr>
            <td>
            <label>{{ _('Select maker') }}</label>
            <div class="input-group">
                {{ formMaker.maker(class="form-control") }}
            </div>
            {% for error in formMaker.errors.maker %}
            <div class="alert alert-danger" role="alert" style="max-width: 400px;">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                [{{error}}]
            </div>
            {% endfor %}
            </td>
        </tr>
        <tr>
            <td>
            <input type="submit" value="{{ _('Continue') }}" class="btn btn-default">
            <input type="button" class="btn btn-info" onclick="window.location.href = '{{ url_for("orders")}}'" value="{{ _('Cancel') }}"/>
            </td>
        </tr>
    </table>
</form>
{% endif %}

{% if products %}
<form action="placeorder" method="post" name="selectProductQuantities">
    {{formQuantities.hidden_tag()}}
    <table class="table table-striped table-condensed td-border-bottom-1px">
        <tr>
            <th style="width: 5%;">{{ _('Code') }}</th>
            <th>{{ _('Name CS') }}</th>
            <th>{{ _('Name JP') }}</th>
            <th style="text-align: right; width: 15%;">{{ _('Order Quantity') }}</th>
        </tr>

        {% for field in formQuantities.fields %}
        {% set product = products[loop.index - 1] %}
        <tr class="tr-product">
            <td>{{ product.code }}</td>
            <td>{{ product.desc_CS }}</td>
            <td>{{ product.desc_JP }}</td>
            <td style="text-align: right;">{{ field.qty_order(size=10, class="form-control input-qty nums_only", style="text-align: right;") }}
                {{ field.product_id(value=product.id) }}
                <span class="span-qty-order" style="display: none; float: right;">0</span>
            {% for error in field.qty_order.errors %}
            <div class="div-error" style="color: red;">[{{error}}]</div>
            {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </table>
    <input type="hidden" name="maker_id" value="{{ products[0].maker_id }}">

    <input type="button" id="btn_check" class="btn btn-default" value="{{ _('Submit') }}"/>
    <input type="button" id="btn_correct" class="btn btn-warning" value="{{ _('Modify') }}" style="display: none;"/>
    <input type="submit" id="btn_submit" value="{{ _('Place order') }}" class="btn btn-danger" style="display: none;">
    <input type="button" class="btn btn-info" onclick="window.location.href = '{{ url_for("orders")}}'" value="{{ _('Cancel') }}"/>
</form>
{% endif %}

<br/>
{% endblock %}